#!/bin/sh
# xdg-open wrapper that forwards URLs to local machine via SSH tunnel
# Falls back to system xdg-open if tunnel socket doesn't exist

SOCK="/tmp/open-forward-${USER}.sock"
FALLBACK=/run/current-system/sw/bin/xdg-open

if [ -S "$SOCK" ]; then
    # Socket exists - forward to local machine
    if printf '%s' "$1" | socat - UNIX-CONNECT:"$SOCK"; then
        echo "succesfully piped into socket $SOCK"
        exit 0
    else
        echo "Warning: Failed to forward through SSH tunnel, falling back to local xdg-open" >&2
        $FALLBACK "$@"
    fi
else
    # No tunnel - use system xdg-open
    echo "no socket - falling back xdg open"
    $FALLBACK "$@"
fi
